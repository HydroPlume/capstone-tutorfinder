<!DOCTYPE html>
<html>
  <head lang="en">
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    
    <!-- Custom Theme CSS, courtesy of https://bootstrapcolors.com/ -->
    <link href="ci-theme.css" rel="stylesheet">

    <title>CI Tutor Finder</title>

    <meta charset="utf-8" />
  </head>
  <body>
    <!-- Navigation bar for that clean look -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">CI Tutor Finder</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">Home</a>
            </li>
            <!-- <li class="nav-item">
              <a class="nav-link" href="#">About</a>
            </li> -->
          </ul>
        </div>
      </div>
    </nav>

    <noscript>
      <div class="container alert alert-ci border border-ci border-2 my-2 text-center" role="alert">
          In order to load tutor schedules, this website requires JavaScript.<br/>
          Your browser either does not support JavaScript or its use has been blocked on this page, possibly by an extension.
      </div>
    </noscript>
    
    <!-- Loading animation while tutor information is being grabbed from Google Sheets -->
    <div class="container text-center">
      <pre id="content" style="white-space: pre-wrap;"></pre>
      <div id="loading-bay" class="d-flex align-items-center">
        <strong>Loading tutor information...</strong>
        <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
      </div>
    </div>
    
    <!-- The main form for selecting a course to find help in -->
    <div class="container-sm" id="course-selection" style="visibility:hidden">
      <div class="row">
        <legend>Select the course id</legend>
      </div>
      <div class="row">
        <div class="col-md">
          <div class="form-floating">
            <select class="form-select" name="course-sub" id="course-sub" onchange="updateCourseNumDropdown();" aria-label="Dropdown for Course Subject"></select>
            <label for="course-sub">Subject</label>
          </div>
        </div>
        <div class="col-sm">
          <div class="form-floating">
            <select class="form-select" name="course-num" id="course-num" aria-label="Dropdown for Course Number"></select>
            <label for="course-num">Number</label>
          </div>
        </div>
      </div>
      <div class="form-text text-center">If you don't see your course listed, then we don't have any tutors available for that course!</div>
      <div class="row justify-content-md-center p-2">
        <div class="col text-center">
          <button class="btn btn-ci" type="button" onclick="displayTutors()">See Tutors!</button>
        </div>
      </div>
      </div>
    </div>

    <!-- This is only a temporary div to display really basic information
        about available tutors that is easy to format -->
    <div class="container-md text-center">
      <ul id="temp-tutor-display"></ul>
    </div>

    <div class="container">
      <table id="timetable" style="display:none">
        <caption><strong>Tutor Availability</strong></caption>
        <thead>
          <tr>
            <th>MONDAY</th>
            <th>TUESDAY</th>
          </tr>
        </thead>
      </table>
    </div>
    
    <script type="text/javascript">
      /**
       * Script modified from Google example; removes all OAuth flow credentials
       * and scope as only public API is needed (only API key required for this)
       * See <https://developers.google.com/sheets/api/quickstart/js>
       */

      // API key from the Developer Console
      const API_KEY = 'AIzaSyBEcAKt2scDQ6WGsmIuubznqv3qZu0Zh40';

      // Array of API discovery doc URLs for APIs used by the quickstart
      const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

      // Define the spreadsheet ids
      const specialtiesSheetID = '1vje4JcWWgUsCAJA7DhEeRfPdI0AJjHP9ECToWULqClI';  // Who does what?
      const timesheetIDs = [  // When are they available?
        '1IndeWlRySoNuQXwMFqSZFY0KAJNr2aHSHR77cRfI16I',  // STEM Tutor Schedule
        // '12sBx4Q3S6_C_NQ3R3oe4izdDs9HoFZrc2oxjInOpafQ',  // Humanities Tutor Schedule
        // ^ Currently has parsing problems; consider including the range in this
        //  structure instead of the TIME_INFO_RANGE const
      ]

      const NAME_SEP = '/';

      const DAY_NAMES = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"];
      const NUM_DAYS = DAY_NAMES.length;
      const TIME_INFO_RANGE = "!A3:K25";  // Each row is a different time; columns represent subjects
      const SPECIALTIES_RANGE = "!A4:B";  // Column A has the Course ID; Col B has tutor names for that course

      var tutorAvailability;
      var tutorSpecialties;
      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        // gapi.load('client:auth2', initClient);
        gapi.load('client', initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: DISCOVERY_DOCS,
        }).then(function () {
          getTutorAvailability().then(tutorAvail => console.debug(tutorAvailability = tutorAvail));
          getTutorSpecialties().then(tutorSpec => {
            // Print out the object for testing in console
            console.debug(tutorSpecialties = tutorSpec);

            // Replace the loading message with the dropdowns
            var selectionDiv = document.getElementById("course-selection");
            selectionDiv.style.visibility = "inherit";
            document.getElementById("loading-bay").classList.add("visually-hidden");

            // Make the first dropdown reflect the available subjects according to
            //  the object we just collected
            updateCourseSubDropdown();
            updateCourseNumDropdown();
          });
        }, function(error) {
          appendPre(JSON.stringify(error, null, 2));
        });
      }

      function displayTutors() {
        // var table = document.getElementById('timetable');
        // table.style.display = 'inherit';
        
        // The HTML structure to write the info to
        var table = document.getElementById('temp-tutor-display');
        table.innerHTML = "";
        var instruct = document.createElement('p');
        instruct.innerHTML = "Click on each day and time to expand the list of available tutors!";
        table.appendChild(instruct);

        // The course subject and number as input by the student
        var courseSub = document.getElementById("course-sub").value;
        var courseNum = document.getElementById("course-num").value;

        // Temporary variable for storing well structured data
        //  in the form day -> time -> tutor
        var tutorStructure = {};

        // Get the available tutors and the times they can be found in the LRC
        for (tutor of tutorSpecialties[courseSub][courseNum]) {
          // console.debug(`Testing ${tutor} for compatibility`);
          for (time in tutorAvailability) {
            for (day in tutorAvailability[time]) {
              // console.debug(`Testing ${tutor} at ${time} on ${day} for compatibility`);
              // Search the available tutors for that day and time to see
              //  if the known supporting tutor works at that time
              if (tutorAvailability[time][day].some( e => tutor.search(e) >= 0 )) {
                // Make time pretty with AM/PM
                // let timePretty = prettyTime(time);
                // Create element and add to the list
                // var e = document.createElement("li");
                // e.innerHTML = `<strong>${timePretty}</strong> on <strong>${day}</strong>, <strong>${tutor}</strong> tutors ${courseSub} ${courseNum}`;
                // table.appendChild(e);

                // Add this day, time, and tutor to our structure
                // Make sure each of these exists in the right location first
                tutorStructure[day] ??= {};
                tutorStructure[day][time] = (tutorStructure[day][time]) ?
                  tutorStructure[day][time].concat(tutor) :
                  [tutor];
              }
            }
          }
        }
        // Now print the tutors neatly
        for (day of DAY_NAMES) {
          // Avoid days that don't exist in the structure
          // Using DAY_NAMES allows us to print the days in order
          if (!tutorStructure[day]) continue;
          // Make our list item for the day, complete with click event
          let d = document.createElement('li');
          d.addEventListener("click", e => toggleCollapse(e.target))
          d.innerHTML = day;
          // Create the list group child where times will be added
          let dList = document.createElement('ul');
          dList.style.display = "none";
          // Now add each available time
          for (time in tutorStructure[day]) {
            // Make our list item for the timeslot, complete with click event
            let t = document.createElement('li');
            t.innerHTML = prettyTime(time);
          // Create the list group child where tutor's names will be added
            let tList = document.createElement('ul');
            tList.style.display = "none";
            for (tutor of tutorStructure[day][time]) {
              let e = document.createElement('li');
              e.innerHTML = tutor;
              tList.appendChild(e);
            }
            t.appendChild(tList);
            dList.appendChild(t);
          }
          d.appendChild(dList);
          table.appendChild(d);
        }
      }

      function updateCourseSubDropdown() {
        // Get the dropdown so we can write to it
        var courseSubDropdown = document.getElementById("course-sub");

        // Change the first dropdown to reflect appropriate course subjects
        courseSubDropdown.innerHTML = "";
        for (sub in tutorSpecialties) {
          var e = document.createElement("option");
          e.value = e.text = sub;
          courseSubDropdown.appendChild(e);
        }
      }

      function updateCourseNumDropdown() {
        // Get the dropdowns so we can read and write values from them
        var courseSubDropdown = document.getElementById("course-sub");
        var courseNumDropdown = document.getElementById("course-num");

        // Change the second dropdown to reflect appropriate course numbers
        //  for the selected subject
        courseNumDropdown.innerHTML = "";
        for (num in tutorSpecialties[courseSubDropdown.value]) {
          var e = document.createElement("option");
          e.value = e.text = num;
          courseNumDropdown.appendChild(e);
        }
      }

      // Make list items collapsable
      function toggleCollapse(elem) {
        if (!(ul = elem.firstElementChild)) return;
        ul.style.display = (ul.style.display == "none") ?
          "block" :
          "none";
      }

      /**
       * Append a pre element to the body containing the given message
       * as its text node. Used to display the results of the API call.
       *
       * @param {string} message Text to be placed in pre element.
       */
      function appendPre(message) {
        var pre = document.getElementById('content');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }

      /**
       * Strip whitespace and unnecessary special characters from names
       *  for easier comparison across spreadsheets
       */
      function slagName(str) {
        return str.match(/[^\s/](?:[^/]*[^\s/])?/)[0].replace(/[-.'*]/, '').toUpperCase();
      }

      // Takes a time and makes it pretty in 12 hour ("10" -> "10 AM")
      // Specifically makes all times < 10 into PM times
      function prettyTime(str) {
        let numericalHour = Number(str.split(':')[0])
        return (numericalHour < 10) ? time+' PM' : time+' AM';
      }
      /**
       * Returns the timetable of which tutors are available at which time
       * Time is the first dimension, followed by weekday, returning an array of names
       * (e.g. timeTable[time][weekDay] => ["Person 1", ...])
       */
      async function getTutorAvailability() {
        var table = document.getElementById('timetable');
        var tutorTimes = {};

        dayRanges = DAY_NAMES.map(dayName => dayName+TIME_INFO_RANGE);
        for (sheetID of timesheetIDs) {
          var resp = await gapi.client.sheets.spreadsheets.values.batchGet({
            spreadsheetId: sheetID,
            ranges: dayRanges
          });

          var timesByDay = resp.result.valueRanges;

          // for (var dayValues of timesByDay) {
          //   var i = 0;
          //   var hour = "";
          //   do {
          //     hour = dayValues.values[i++][0];
          //   } while (!hour)
          //   // console.log(`First Hour of ${dayValues.range.match(/\w+/)[0]}: ${hour}`);
          // }

          // Go through each day's data and pull information on what tutors are available when
          for (var dayValues of timesByDay) {
            var dayName = dayValues.range.match(/\w+/)[0];
            // Traverse each subarray (representing the different times) and collect a set of names
            for (var hourData of dayValues.values) {
              var [time, ...tutors] = hourData;
              // Skip rows with no value in the first column (means it's not a row containing times)
              if (!time || time == "" || time.search(/^[0-9]/) < 0) continue;
              // Create dict if needed
              tutorTimes[time] ??= {};
              // Remove empty cells and duplicates (convert to set and back)
              tutors = [...new Set(tutors.filter(s => typeof(s) == "string" && s.length > 0)
              // Split names apart at separator and reduce to single level array
                .reduce((a,s) => a.concat(s.split('/')), new Array())
              // Clean up names so they are easier to compare / more uniform
                .map(slagName))];
              // Add tutors to the proper day and time in our information table
              if (tutors.length == 1 && tutors[0].search(/CLOSE/i) >= 0) {
                console.debug(`${dayName} at ${time} thrown out; only tutors were: ${tutors}`)
                continue;
              }
              tutorTimes[time][dayName] = (tutorTimes[time][dayName]) ?
                tutorTimes[time][dayName].concat(tutors) :
                tutors;
              // console.log(`Tutors available ${dayName} at ${time}: ${tutors}`);
            }
          }
        }
        // for (x in tutorTimes) {console.log(`${x} : ${tutorTimes[x]}`);}
        // Display the final table built
        return tutorTimes;
      }

      /**
      * Returns the table of what tutors work for each course
      * Course subject is the first dimension, followed by the course number
      * (e.g. specialtyTable[sub][num] => ["Person 1", ...])
      */
      async function getTutorSpecialties() {
        
        // Get the title of each worksheet, representing available subjects
        resp = await gapi.client.sheets.spreadsheets.get({
          spreadsheetId: specialtiesSheetID,
        });

        var availableSubjectsRange = resp.result.sheets.map(s => s.properties['title']+SPECIALTIES_RANGE);

        // Get all of the worksheets
        resp = await gapi.client.sheets.spreadsheets.values.batchGet({
          spreadsheetId: specialtiesSheetID,
          ranges: availableSubjectsRange,
        });

        var tutorsBySubject = resp.result.valueRanges;
        var tutorSpecialties = {};

        // Iterate over the pages 
        for (subject of tutorsBySubject) {
          // Iterate over each course listed
          for (course of subject.values) {
            // Skip adding courses with no tutors listed
            if (course.length < 2) {
              console.debug(`No tutors found for: ${course}`)
              continue;
            }
            // First parse through the tutors, since we'll be adding them to
            //  the potentially multiple courses listed on each line
            var tutors = course[1].split(',').map(slagName);

            /* Now we must separate the course IDs into sensible parts.
             * The IDs are written in a decently parseable way by default, but
             *  we need some special care to make sure we grab all possible
             *  combinations listed
             * For instance, sometimes two courses are listed together separated
             *  by an &; sometimes courses are cross listed and will need to have
             *  multiple subjects attributed to the same number
             * The overall structure looks like:  SUB / SUB NUM & SUB NUM - TITLE;
             * In order to allow for ignorable whitespace, regex is partially used
             **/
            
            // Start by iterating over each separate course as marked by '&'
            for (individualCourse of course[0].split('-',1)[0].split('&')) {
              // Parse into subjects and number parts
              courseParts = individualCourse.match(/(?<sub>[a-z/ ]+?)\s*(?<num>[0-9]+)\s*$/i);
              // If there are no matches, then we assume the entry is not a valid course
              // While I'd like the timetable to offer broad subjects as well, it is too
              //  complicated to program that for this version
              if (!courseParts) continue;
              // Set the numerical part
              var courseNumber = courseParts.groups['num'];
              // Get the neatly formatted subjects
              var courseSubjects = courseParts.groups['sub'].split('/').map(s => s.match(/\w+/i)[0].toUpperCase());
              // Now add the tutors to each combo of subject and number given
              for (subjectCode of courseSubjects) {
                // Make new structures if they don't yet exist
                tutorSpecialties[subjectCode] ??= {};
                tutorSpecialties[subjectCode][courseNumber] ??= new Array();
                // Add the tutors listed; this is written assuming someone will
                //  one day accidentally write the same course in two separate
                //  places, at which point the code will still work beautifully
                tutorSpecialties[subjectCode][courseNumber] = tutorSpecialties[subjectCode][courseNumber].concat(tutors);
              }
            }
          }
        }
        return tutorSpecialties;
      }

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>
